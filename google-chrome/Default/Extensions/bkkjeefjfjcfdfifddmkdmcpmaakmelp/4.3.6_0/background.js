import { e, r as r$1 } from './chunks/browser-polyfill-1756fcfb.js';
import { o } from './chunks/index-fe22708a.js';
import { r } from './chunks/create-cbc9c419.js';
import { W as We, t, e as e$2 } from './chunks/router.interface-f478261b.js';
import { r as r$2 } from './chunks/parse_token.util-f24eec6b.js';
import { o as o$1 } from './chunks/storage-f52a9ff9.js';
import { e as e$1, o as o$2 } from './chunks/index-1fb6b074.js';
import './chunks/transframe-provider-e657167f.js';
import './chunks/request-ce61d6cc.js';

var d=e=>`notification_job:${e}`,p=/^(http|https):\/\/*/;const m=["https://*.truffle.vip/*"],v=["youtube.com","twitch.tv","patreon.com"];console.log("PRIVILEGED_ORIGINS",m),console.log("MODIFIED_FETCH_DOMAINS",v);const h=e.exports.runtime.getManifest().manifest_version<3;function f(e){return {id:1,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,responseHeaders:e.map((e=>({header:e,operation:chrome.declarativeNetRequest.HeaderOperation.REMOVE})))},condition:{requestDomains:["patreon.com","youtube.com","twitch.tv"],initiatorDomains:m,resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME,chrome.declarativeNetRequest.ResourceType.SUB_FRAME]}}}r({api:{fetchWithRulesApplied:async(e$1,n,o,{headersToRemove:r}={})=>{const a=new URL(n),s=a.hostname.split(".").slice(-2).join(".");if(!v.includes(s))throw new Error(`Domain not whitelisted: ${a.hostname}`);let i;r&&(i=h?await function(e$1){const n=e$1.map((e=>e.toLowerCase())),o=e=>{var t;return {responseHeaders:null===(t=e.responseHeaders)||void 0===t?void 0:t.filter((e=>!n.includes(e.name.toLowerCase())))}};return e.exports.webRequest.onHeadersReceived.addListener(o,{urls:v.map((e=>`https://*${e}*`))},["blocking","responseHeaders"]),()=>e.exports.webRequest.onHeadersReceived.removeListener(o)}(r):await async function(e){const t=[f(e)];return await chrome.declarativeNetRequest.updateSessionRules({addRules:t}),()=>{chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:t.map((e=>e.id))});}}(r));const c=fetch(n,o);i&&i();return (await c).text()}},namespace:"truffle-background-privileged-api-v1"});const g={users:async e=>{if(!e)return "[]";const t=`https://v2.truffle.vip/gateway/users/v2/c/${e}`;return (await fetch(t)).text()},emotes:async e=>{const t="https://v2.truffle.vip/gateway/emotes",n=e?`${t}/c/${e}`:t;return (await fetch(n)).text()},badges:((e,{cacheExpirationMs:t$1=t.ONE_SECOND_MS,cacheControlFallback:n=t.FIVE_MINUTE_SECONDS}={})=>async()=>(async(e,{cacheExpirationMs:t$1=t.ONE_SECOND_MS,cacheControlFallback:n=t.FIVE_MINUTE_SECONDS}={})=>{var o,a;const s=await o$1.cache.get(e);let i;if(s&&s.expiresAt>Date.now())i=s.value;else {const r=await fetch("https://v2.truffle.vip"+e),s=Number(r.headers.get("age")),l=Number((null===(a=null===(o=r.headers.get("cache-control"))||void 0===o?void 0:o.match(/max-age=(\d+)/))||void 0===a?void 0:a[1])||n)-s,u=Date.now()+l*t$1;i=await r.json(),await o$1.cache.set(e,{expiresAt:u,value:i});}return i})(e,{cacheControlFallback:n,cacheExpirationMs:t$1}))("/gateway/badges"),"set-settings":async e=>{const t=await o$1.auth.get("token"),n=await fetch("https://v2.truffle.vip/gateway/settings",{method:"PUT",headers:{Authorization:`Bearer ${t}`},body:JSON.stringify(e)}),{jwt:o}=await n.json();return o$1.auth.set("token",o),r$2(o)}};let y=null;async function w(){const e=await chrome.declarativeNetRequest.getSessionRules();chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:e.map((e=>e.id))});}function b(e){return {id:1,priority:1,action:{type:chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,responseHeaders:e.map((e=>({header:e,operation:chrome.declarativeNetRequest.HeaderOperation.REMOVE})))},condition:{urlFilter:"*",resourceTypes:[chrome.declarativeNetRequest.ResourceType.MAIN_FRAME,chrome.declarativeNetRequest.ResourceType.SUB_FRAME]}}}async function I(e,t$1,{expireSeconds:n=t.ONE_MINUTE_SECONDS}={}){const o=await o$1.cache.get(e);let a,s;const i=(null==o?void 0:o.expiresAt)<Date.now();if((null==o?void 0:o.value)&&!i)a=o.value,s=!0;else {a=await t$1(),s=!1;const o=Date.now()+n*t.ONE_SECOND_MS;await o$1.cache.set(e,{expiresAt:o,value:a});}return {value:a,isCached:s}}async function R(e){await o$1.cache.remove(e);}const S=(e,t)=>`${e}:${t}`;function k(e,t){const n=function(e){if(null==e?void 0:e.nodes)return e.nodes.map((e=>{if(e)return function(e){var t,n,o,r,s;return {id:null===(t=null==e?void 0:e.collectible)||void 0===t?void 0:t.id,name:null===(n=null==e?void 0:e.collectible)||void 0===n?void 0:n.slug,ext:null===(s=null===(r=null===(o=null==e?void 0:e.collectible)||void 0===o?void 0:o.fileRel)||void 0===r?void 0:r.fileObj)||void 0===s?void 0:s.ext,provider:e$2.Spore}}(e)})).filter(C);return []}(null==t?void 0:t.ownedCollectibleConnection),o=(r=null==t?void 0:t.ownedCollectibleConnection,null===(s=null==r?void 0:r.nodes)||void 0===s?void 0:s.map((e=>{var t;return null===(t=null==e?void 0:e.collectible)||void 0===t?void 0:t.slug})));var r,s;const i=function(e){var t;return null===(t=null==e?void 0:e.nodes)||void 0===t?void 0:t.map((e=>{var t;return null===(t=null==e?void 0:e.powerup)||void 0===t?void 0:t.slug}))}(null==t?void 0:t.activePowerupConnection),c=function(e){var t;const n=null===(t=null==e?void 0:e.keyValueConnection.nodes.find((e=>"subbedMonths"===e.key)))||void 0===t?void 0:t.value;return n?parseInt(n):0}(t),l=function(e){var t;return null===(t=null==e?void 0:e.keyValueConnection.nodes.find((e=>"nameColor"===e.key)))||void 0===t?void 0:t.value}(t);return {id:e,emotes:o,badges:i,name:(null==t?void 0:t.name)||(null==t?void 0:t.user.name),subbedMonths:c,nameColor:l,serializedEmotes:n}}const C=e=>!!e;async function E(e,t,n,{throwIfErrors:o}={}){var r;const a=await fetch(e,{method:"POST",headers:{Authorization:"Bearer pk_U1x92ZrrdQoflf2JycecdmnilAGRAkmUNBpxPnVPDdeUKcsH","Content-Type":"application/json"},body:JSON.stringify({query:t,variables:n})}),s=await a.json();if(o&&(null===(r=s.data)||void 0===r?void 0:r.errors))throw new Error(`spore graphql error ${s.data.errors}`);return s.data}const N={gateway:g,auth:{"@me":async()=>{const e=await o$1.auth.get("token");return r$2(e)},token:async()=>await o$1.auth.get("token"),login:async t=>{const n=await(o=t.href,r$1.cookies.getAll({url:o}).then((e=>e.filter((e=>!e.name.startsWith("ST-"))).map((e=>[e.name,e.value])))).then(Object.fromEntries));var o;const r=await async function(e,t){const n={cookies:e,request:t};try{return await E("https://zygote.spore.build/graphql","mutation MogulTVYoutubeLogin($cookies: JSON, $request: JSON) {\n\t\tmogulTvYoutubeLogin(cookies: $cookies, request: $request)\n}",n)}catch(e){console.error(e);}}(n,t),a=null==r?void 0:r.mogulTvYoutubeLogin;if(a)return await o$1.auth.set("token",a),r$2(a)},"get-access-token":()=>e$1(),"set-access-token":async e=>{await o$2(e);}},extension:{popup:()=>r$1.action.openPopup(),"open-tab":async t=>{await r$1.tabs.create({url:t});},"fcm-token":async()=>{if(!chrome.gcm)return null;const{fcmToken:t}=await r$1.storage.local.get("fcmToken");return t},"remove-request-headers-temporarily":async({headers:t,ttlMs:n})=>{if(y&&clearTimeout(y),r$1.runtime.getManifest().manifest_version<3){const o=t.map((e=>e.toLowerCase())),r=e=>{var t;return {responseHeaders:null===(t=e.responseHeaders)||void 0===t?void 0:t.filter((e=>!o.includes(e.name.toLowerCase())))}};r$1.webRequest.onHeadersReceived.addListener(r,{urls:["<all_urls>"]},["blocking","responseHeaders"]),y=setTimeout((()=>{r$1.webRequest.onHeadersReceived.removeListener(r);}),n);}else await w(),await chrome.declarativeNetRequest.updateSessionRules({addRules:[b(t)]}),y=setTimeout((()=>{w();}),n);},"set-cookie-same-site-none":async({url:t,name:n})=>{const o=await r$1.cookies.get({url:t,name:n});r$1.cookies.set({domain:null==o?void 0:o.domain,expirationDate:null==o?void 0:o.expirationDate,httpOnly:null==o?void 0:o.httpOnly,name:null==o?void 0:o.name,path:null==o?void 0:o.path,sameSite:"no_restriction",secure:null==o?void 0:o.secure,storeId:null==o?void 0:o.storeId,url:t,value:null==o?void 0:o.value});}},spore:{"invalidate-spore-user-cache":async({connectionSourceId:e,sporeOrgId:t}={})=>R(S(e,t)),"fetch-spore-user":async({connectionSourceId:e,sporeOrgId:t,invalidateCache:n=!1}={})=>{const o=S(e,t);return n&&await R(o),I(o,(async()=>{const n=await async function(e,t){const n={sourceType:"youtube",sourceId:e,collectibleType:"emote",orgId:t};try{return (await E("https://zygote.spore.build/graphql","query CacheableConnectionCollectiblesPowerupsConnectionBySourceAndOrg (\n    $sourceType: String, $sourceId: String, $collectibleType: String!, $orgId: ID)\n    {\n        connection(sourceType: $sourceType, sourceId: $sourceId, orgId: $orgId) {\n          id\n          orgId\n          userId\n          sourceType\n          sourceId\n          secondarySourceId\n          orgUser {\n            id\n            userId\n            orgId\n\t\t\t\t\t\tname\n\t\t\t\t\t\tkeyValueConnection {\n\t\t\t\t\t\t\tnodes {\n\t\t\t\t\t\t\t\tkey\n\t\t\t\t\t\t\t\tvalue\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tuser {\n\t\t\t\t\t\t\tname\n\t\t\t\t\t\t}\n            ownedCollectibleConnection(collectibleType: $collectibleType) {\n                nodes {\n                    userId\n                    collectible {\n                        id\n                        name\n                        slug\n                        fileRel {\n                            fileObj {\n                                src\n                                ext\n                            }\n                        }\n                    }\n                }\n            }\n            activePowerupConnection {\n                totalCount\n                nodes {\n                    id\n                    userId\n                    data {\n                            rgba\n                        }\n                    powerup {\n                        id\n                        slug\n\n                        componentRels {\n                            props\n                        }\n                    }\n                }\n            }\n        }\n    }\n}",n)).connection}catch(e){console.error(e);}}(e,t);return k(e,null==n?void 0:n.orgUser)}),{expireSeconds:60})},"fetch-youtube-channel":async e=>{const t=(e=>`spore-org-yt-channel:${e}`)(e);return I(t,(()=>async function(e){const t={id:e};try{return (await E("https://zygote.spore.build/graphql","query YoutubeChannelById($id: String) {\n\tyoutubeChannel(id: $id) {\n\t\tid\n\t\tsporeOrgId\n\t\tchannelName\n\t\tisLive\t\n\t\tseasonPass {\n\t\t\tname\n\t\t}\n\t}\n}",t)).youtubeChannel}catch(e){console.error(e);}}(e)),{expireSeconds:60})},"fetch-max-super-chat-cents":async e=>{const t=(e=>`spore-org-config:${e}`)(e);return I(t,(async()=>{var t,n;const o=await async function(e){const t={orgId:e};try{return (await E("https://zygote.spore.build/graphql","query OrgConfigByOrgId($orgId: ID) {\n\torgConfig(orgId: $orgId) { data }\n}",t)).orgConfig}catch(e){console.error(e);}}(e);return null===(n=null===(t=null==o?void 0:o.data)||void 0===t?void 0:t.youtubeSettings)||void 0===n?void 0:n.maxSuperChatCents}),{expireSeconds:60})},"fetch-is-experimental-enabled":async()=>o$1.settings.get("experimental"),"fetch-is-twitch-following-enabled":async()=>o$1.settings.get("twitchFollowing")},twitch:{"get-gql-headers":async()=>o$1.twitch.get("headers"),"set-gql-headers":async e=>{await o$1.twitch.set("headers",e);}}},x=(e,t={},n)=>({body:t,meta:{isSuccess:!1,code:e,nonce:n}}),T=async(e,t)=>{var n;const{path:o,body:r}=e;if(!o)return;e.meta?e.meta.sender=t:e.meta={sender:t,isPort:!1},e.meta.isPort||(e.meta.isPort=!1);const a=e=>{},i=o.split("/").filter(Boolean),c=i[0];if(!(c in N)){return x(We.NotFound,void 0,e.nonce)}const l=N[c][i.slice(1).join("/")];if(!l){return x(We.NotFound,void 0,e.nonce)}try{const t=((e,t)=>({body:e,meta:{isSuccess:!0,code:We.Success,nonce:t}}))(await l(r,e.meta),e.nonce);return a(t),t}catch(t){const o=t;return x(null!==(n=o.code)&&void 0!==n?n:We.Unknown,{message:o.message},e.nonce)}};r$1.runtime.setUninstallURL("https://truffle.vip/extension-survey"),chrome.runtime.onStartup.addListener((()=>{console.log("onStartup()");})),r$1.runtime.onConnect.addListener((t=>{const n=t.sender;if(!n)return;const o=(e,n,o)=>{t.postMessage({type:"tab:updated",tabId:e,changeInfo:n,tab:o});};t.onDisconnect.addListener((()=>{r$1.tabs.onUpdated.removeListener(o);})),t.onMessage.addListener((async e=>{e.meta={isPort:!0};const o=await T(e,n);t.postMessage(o);})),r$1.tabs.onUpdated.addListener(o);})),r$1.runtime.onMessage.addListener(T),chrome.gcm&&(chrome.runtime.onInstalled.addListener((t=>{console.log("extention installed"),console.log("info",t),chrome.instanceID.getToken({authorizedEntity:"277610744288",scope:"GCM"}).then((t=>{console.log("FCM token",t),r$1.storage.local.set({fcmToken:t});}));})),chrome.gcm.onMessage.addListener((function(t){if(!chrome.gcm)return;let n="/assets/icon48.png",o=t?.data??{},r=o.notificationId??o.notificationJobId,a={type:"basic",title:o.notificationTitle??o["gcm.notification.title"]??" ",message:o.notificationBody??o["gcm.notification.body"]??" ",iconUrl:o.notificationIcon??o["gcm.notification.icon"]??n};r$1.storage.local.set({[d(r)]:o}),chrome.notifications.create(r,a,(()=>{let e=chrome.runtime.lastError;e&&(console.error("Error displaying notification:",e),a.iconUrl=n,chrome.notifications.create(r,a));}));})),chrome.notifications.onClicked.addListener((async function(t){let n=d(t),o=(await r$1.storage.local.get(n))?.[n];if(r$1.storage.local.remove(n),!o)return;let{action:r}=o;r&&p.test(r)&&r$1.tabs.create({url:r});}))),e.exports.runtime.onInstalled.addListener((async e$1=>{if("install"===e$1.reason){const e$1="https://app.truffle.vip/getting-started?reset=true";await e.exports.tabs.create({url:e$1});}})),e.exports.runtime.onMessageExternal.addListener((async function(e,t){if("pmnmpgjfacmjcnfigcmgfipemjpggmeg"!==t.id)return;const o$1=e.namespace,r=e.key;if(o$1&&r){if("get"===e.type)return o[o$1].get(r);if("set"===e.type){if(!e.data)return;return await o[o$1].set(r,e.data),!0}}}));
