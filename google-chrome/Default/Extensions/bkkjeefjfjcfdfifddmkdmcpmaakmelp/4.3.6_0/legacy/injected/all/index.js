import { e } from '../../../chunks/background.injected-0c5a5e2d.js';
import { r as r$1 } from '../../../chunks/parse_token.util-f24eec6b.js';
import { a as a$1 } from '../../../chunks/consumer-8ba9c119.js';
import '../../../chunks/index-5e67059d.js';
import '../../../chunks/transframe-provider-e657167f.js';
import '../../../chunks/create-5399fd46.js';

var r=100,o=-1,s={"-32601":"Method not found"};s[r]="Invalid origin",s[o]="Error";var a=class{constructor({postMessage:e,timeout:t=3e3}={}){this.postMessage=e,this.timeout=t,this.pendingRequests={},this.callbackFunctions={},this.call=this.call.bind(this),this.resolve=this.resolve.bind(this),this.resolveRPCResponse=this.resolveRPCResponse.bind(this);}call(e,t,n={}){let{timeout:r=this.timeout}=n,o=function(){let e=null,t=null,n=new Promise(((n,r)=>(e=n,t=r,t)));return n.resolve=e,n.reject=t,n}(),s=[];for(let e of Array.from(t||[]))if("function"==typeof e){let t={_browserComms:!0,_browserCommsGunCallback:!0,callbackId:m()};this.callbackFunctions[t.callbackId]=e,s.push(t);}else s.push(e);let a=function({method:e,params:t}){if(null==t)throw new Error("Must provide params");for(let e of Array.from(t))if("function"==typeof e)throw new Error("Functions are not allowed. Use RPCCallback instead.");return {_browserComms:!0,id:m(),method:e,params:t}}({method:e,params:s});this.pendingRequests[a.id]={reject:o.reject,resolve:o.resolve,isAcknowledged:!1};try{this.postMessage(JSON.stringify(a),"*");}catch(e){return o.reject(e),o}return setTimeout((()=>{if(!this.pendingRequests[a.id].isAcknowledged)return o.reject(new Error("Message Timeout"))}),r),o}resolve(e){switch(!1){case t=e,!(!0===t?.acknowledge):return this.resolveRPCRequestAcknowledgement(e);case!d(e):return this.resolveRPCResponse(e);case!function(e){return e?.callbackId&&null!=e.params}(e):return this.resolveRPCCallbackResponse(e);default:throw new Error("Unknown response type")}var t;}resolveRPCResponse(e){let t=this.pendingRequests[e.id];if(null==t)throw new Error("Request not found");t.isAcknowledged=!0;let{result:n,error:r}=e;return r?t.reject(r.data||new Error(r.message)):null!=n?t.resolve(n):t.resolve(null),null}resolveRPCRequestAcknowledgement(e){let t=this.pendingRequests[e.id];if(null==t)throw new Error("Request not found");return t.isAcknowledged=!0,null}resolveRPCCallbackResponse(e){let t=this.callbackFunctions[e.callbackId];if(null==t)throw new Error("Callback not found");return t(...e.params||[]),null}};function i({params:e,callbackId:t}){return {_browserComms:!0,callbackId:t,params:e}}function l({requestId:e,result:t=null,rPCError:n=null}){return {_browserComms:!0,id:e,result:t,error:n}}function u({code:e,data:t=null}){return {_browserComms:!0,code:e,message:s[e],data:t}}function c(e){return e?._browserComms}function d(e){return e?.id&&(void 0!==e.result||void 0!==e.error)}function m(){let e=(new Date).getTime(),t=typeof performance<"u"&&performance.now&&1e3*performance.now()||0;return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(n){let r=16*Math.random();return e>0?(r=(e+r)%16|0,e=Math.floor(e/16)):(r=(t+r)%16|0,t=Math.floor(t/16)),("x"===n?r:3&r|8).toString(16)}))}var h=1e4,p=typeof document<"u"?window:typeof self<"u"?self:null,f=class{constructor(e={}){let{timeout:t,shouldConnectToServiceWorker:n,handshakeTimeout:r=h,isParentValidFn:o=(()=>!0)}=e;this.handshakeTimeout=r,this.isParentValidFn=o,this.isListening=!1,this.isNotTopWindow=typeof document<"u"&&window.self!==window.top,this.hasParent=globalThis?.window?.ReactNativeWebView||this.isNotTopWindow,this.isNotTopWindow?this.parent=globalThis?.window?.parent:this.parent=globalThis?.window?.ReactNativeWebView||globalThis?.window?.parent,this.client=new a({timeout:t,postMessage:(e,t)=>{globalThis?.window?.ReactNativeWebView&&!this.isNotTopWindow?this.parent?.postMessage(e):this.parent?.postMessage(e,t);}}),this.waitForSw=n&&function(){return new Promise(((e,t)=>{let n=setTimeout(e,5e3);return navigator?.serviceWorker?.ready.catch((function(){return console.log("caught sw error"),null})).then((t=>{let r=t?.active;return r&&(this.sw=new a({timeout:this.timeout,postMessage:(e,t)=>{let n=new MessageChannel;if(n)return n.port1.onmessage=e=>this.onMessage(e,{isServiceWorker:!0}),r.postMessage(e,[n.port2])}})),clearTimeout(n),e()}))}))}(),this.registeredMethods={ping:()=>Object.keys(this.registeredMethods)},this.parentsRegisteredMethods=[],this.parentHasMethod=this.parentHasMethod.bind(this),this.setParent=this.setParent.bind(this),this.listen=this.listen.bind(this),this.close=this.close.bind(this),this.call=this.call.bind(this),this.onRequest=this.onRequest.bind(this),this.onMessage=this.onMessage.bind(this),this.on=this.on.bind(this);}setParent(e){this.parent=e,this.hasParent=!0;}listen(){this.isListening=!0,p.addEventListener?.("message",this.onMessage,!0),this.waitForParentPing=this.hasParent&&this.client.call("ping",null,{timeout:this.handshakeTimeout}).then((e=>{this.parentsRegisteredMethods=this.parentsRegisteredMethods.concat(e);})).catch((()=>null)),this.waitForSwPing=this.waitForSw&&this.waitForSw.then((()=>this.sw?.call("ping",null,{timeout:this.handshakeTimeout}))).then((e=>{this.parentsRegisteredMethods=this.parentsRegisteredMethods.concat(e);})).catch((()=>null));}close(){return this.isListening=!0,p?.removeEventListener("message",this.onMessage)}parentHasMethod(e){return -1!==this.parentsRegisteredMethods.indexOf(e)}async call(e,...t){if(!this.isListening)return new Promise(((e,t)=>t(new Error("Must call listen() before call()"))));let n=(e,t)=>{let n=this.registeredMethods[e];if(!n)throw new Error("Method not found: "+e);return n(...t)};if(this.waitForSw&&await this.waitForSw,!this.hasParent&&!this.sw)return n(e,t);{let r=null;if(this.waitForParentPing&&await this.waitForParentPing,this.waitForSwPing&&await this.waitForSwPing,this.parentHasMethod(e)){let o;try{if(!this.hasParent)throw new Error("No parent");o=await this.client.call(e,t);}catch(s){try{if(r=s,!this.sw)return n(e,t);try{o=await this.sw.call(e,t);}catch{return n(e,t)}}catch(e){throw "Method not found"===e.message&&r?r:e}}if("ping"===e){let r=n(e,t);o=(o||[]).concat(r);}return o}return n(e,t)}}async onRequest(e,t,n){let r=[];for(let n of Array.from(t.params||[]))s=n,s?._browserCommsGunCallback?(t=>{r.push(((...n)=>e(i({params:n,callbackId:t.callbackId}))));})(n):r.push(n);var s;e(function({requestId:e}){return {_browserComms:!0,id:e,acknowledge:!0}}({requestId:t.id}));try{let o=await this.call(t.method,...Array.from(r),{e:n});return e(l({requestId:t.id,result:o}))}catch(n){return e(l({requestId:t.id,rPCError:u({code:o,data:n})}))}}onMessage(e,{isServiceWorker:t,reply:n}={}){try{let s="string"==typeof e.data?JSON.parse(e.data):e.data;if(!c(s))return;if(n=n||function(t){return typeof document<"u"&&null!==window?e.source?.postMessage(JSON.stringify(t),"*"):e.ports[0].postMessage(JSON.stringify(t))},o=s,null!=o?.id&&null!=o.method)return this.onRequest(n,s,e);if(c(s)){let n;if(this.isParentValidFn(e.origin))return n=t?this.sw:this.client,n.resolve(s);if(d(s))return n=t?this.sw:this.client,n.resolve(l({requestId:s.id,rPCError:u({code:r})}));throw new Error("Invalid origin")}throw new Error("Unknown RPCEntity type")}catch{}var o;}on(e,t){this.registeredMethods[e]=t;}};var g="width: 0; height: 0;",w="truffle";var b,y=((b=y||{}).ANDROID="native-android",b.IOS="native-ios",b.CHROME="extension-chrome",b.FIREFOX="extension-firefox",b.SAFARI="extension-safari",b);function v(e){return void 0!==e.image}var E=["src","width","height","id","class"];var I=e=>`data-truffle-assoc-mutation-observer-id-${e}`,S=e=>`data-truffle-assoc-mutated-element-id-${e}`,M="data-truffle-id",C=e=>`[${M}=${e}]`,k="data-truffle-has-mutated";function x(e,{subjectElement:t,mutationObserverId:n,mutatedElementId:r,cleanupMutationsByMutatedElementId:o}={}){let s=document.documentElement,a=e=>{n&&e.setAttribute(I(n),"1"),r&&e.setAttribute(S(r),"1");};return e.forEach((e=>{switch(e.action){case"appendSubject":t&&s?.appendChild(t);break;case"prependSubject":t&&s?.prepend(t);break;case"resetStyles":s&&s.setAttribute("style",g);break;case"cleanupMutationsByMutatedElementId":e.value&&o&&o(e.value);break;case"useDocument":s=document.documentElement;break;case"getIframeDocument":{let e=s;s=e?.contentDocument?.documentElement??e?.contentWindow?.document?.documentElement;break}case"insertSubjectBefore":t&&s?.parentNode?.insertBefore(t,s);break;case"insertSubjectAfter":t&&s?.parentNode?.insertBefore(t,s?.nextSibling);break;case"querySelector":e.value&&(s=s?.querySelector(e.value));break;case"createImageSubject":{let n=function(e){return void 0!==e.src}(e.value)?e.value:JSON.parse(e.value),r=document.createElement("img");Object.entries(n).forEach((([e,t])=>{(function(e){return E.includes(e)})(e)&&r.setAttribute(e,t);})),a(t=r);break}case"replaceStringsWithImages":(v(e.value)?e.value:JSON.parse(e.value)).forEach((({string:e,image:t})=>{let n=document.createElement("img");n.src=P(t.src),t.height&&(n.height=t.height),t.width&&(n.width=t.width),n.title=e,s&&O(s,e,n).forEach(a);}));break;case"createReplacedStringsWithImagesSubject":{let n=v(e.value)?e.value:JSON.parse(e.value),r=s;if(n.forEach((({string:e,image:t})=>{let n=document.createElement("img");n.src=P(t.src),t.height&&(n.height=t.height),t.width&&(n.width=t.width),n.title=e,r&&(r=function(e,t,n){let r=document.createElement("template");for(let o of e.childNodes)if(o.nodeType===Node.TEXT_NODE){let e=document.createElement("template"),s=o.textContent?.replaceAll(t,n.outerHTML);s&&(e.innerHTML=s,r.append(...e.content.childNodes));}else r.appendChild(o);return r}(r,e,n));})),r!==s){let e=document.createElement("span");e.append(...r?.childNodes??[]),a(e),t=e;}else t=null;break}case"replaceWithSubject":t&&s?.replaceWith(t);break;case"requestPictureInPicture":s?.requestPictureInPicture?.();break;case"setStyle":{let t="string"==typeof e.value?JSON.parse(e.value):e.value;Object.entries(t).forEach((([e,t])=>{s&&(s.style[e]=t);}));break}case"setStyleSheet":{let t="string"==typeof e.value?JSON.parse(e.value):e.value,n=t?.id?document.getElementById(t?.id):document.createElement("style");n||(n=document.createElement("style")),document.head.appendChild(n),n.innerText=e.value?.css??t.css,t?.id&&(n.id=t?.id),t?.class&&(n.className=t?.class),a(n);break}case"setId":s&&e.value&&(s.id=e.value);break;case"addClassNames":if(!s)break;Array.isArray(e.value)?s.classList.add(...e.value):"string"==typeof e.value&&s.classList.add(e.value);break;case"removeClassNames":if(!s)break;Array.isArray(e.value)?e.value.forEach((e=>s?.classList.remove(e))):"string"==typeof e.value&&s.classList.remove(e.value);break;case"webComponentMethod":{if(!s)break;let t="string"==typeof e.value?JSON.parse(e.value):e.value;s?.[t.method]?.(...t.args);break}case"useSubject":s=t;}})),r&&document.querySelector(C(r))?.setAttribute(k,"1"),s}function P(e){let t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText}function O(e,t,n){let r=[];for(let o of e.childNodes)switch(o.nodeType){case Node.ELEMENT_NODE:r.push(...O(o,t,n));break;case Node.TEXT_NODE:{let e=j(o);e&&(e.innerHTML=e.innerHTML.replace(t,n.outerHTML),r.push(e));break}case Node.DOCUMENT_NODE:r.push(...O(o,t,n));}return r}function j(e){let t=document.createElement("span");if(e?.textContent&&e?.parentNode){let n=document.createTextNode(e.textContent);return t.appendChild(n),e.parentNode.replaceChild(t,e),t}}var T,L=class{},N=new class extends L{getPageIdentifiers(){return [{sourceType:"url",sourceId:window.location.href}]}getPageInfo(){return {title:document.title,url:window.location.href,contentPageId:"",contentPageOwnerRef:"",site:"genericSite",contentPageType:"url",data:{}}}},R=/[a-zA-Z0-9]+/,A=new class extends L{getPageIdentifiers(){let e=[{sourceType:"url",sourceId:window.location.href}];if("player.twitch.tv"===window.location.hostname.replace(/^www\./,"")){let t=new URLSearchParams(window.location.search),n=Object.fromEntries(t.entries());e=e.concat({sourceType:"twitchEmbed",sourceId:n.channel});}else {let t=window.location.pathname.match(R)?.[0];t&&(e=e.concat({sourceType:"twitch",sourceId:t}));}return e}getPageInfo(){let e,t,n;if("player.twitch.tv"===window.location.hostname.replace(/^www\./,"")){e="twitchEmbed";let r=new URLSearchParams(window.location.search),o=Object.fromEntries(r.entries());n=o.channel,t=o.channel;}else {e="twitch";let r=window.location.pathname.match(R)?.[0];t=r||"",n=r||"";}return {title:document.title,url:window.location.href,contentPageType:e,contentPageId:n,contentPageOwnerRef:t,site:"twitch",data:{}}}};var q,B=new class extends L{getPageIdentifiers(e){let t=["native-android","native-ios"].includes(e),n=document.querySelector(t?"ytm-app":"ytd-page-manager")?.data?.playerResponse?.videoDetails,r=[{sourceType:"url",sourceId:window.location.href}];if(n?.channelId){let e=n.channelId,t=n.videoId,o=n.isLiveContent?"youtubeLiveContent":"youtubeVideo";r.push({sourceType:"youtube",sourceId:e}),r.push({sourceType:o,sourceId:e,data:{videoId:t}}),n.isLiveContent&&r.push({sourceType:n.isLive||n.isUpcoming?"youtubeLive":"youtubeVod",sourceId:e,data:{videoId:t}});}return r}getPageInfo(){let e,t=["native-android","native-ios"].includes(T),n=document.querySelector(t?"ytm-app":"ytd-page-manager")?.data?.playerResponse?.videoDetails;return e=n?.isLiveContent?n.isLive?"youtubeLiveNow":n.isUpcoming?"youtubeLiveUpcoming":"youtubeVod":"youtubeVideo",{title:n?.title||document.title,url:window.location.href,contentPageType:e,contentPageId:n?.videoId||"",contentPageOwnerRef:n?.channelId||"",site:"youtube",data:{}}}},D={genericSite:N,twitch:A,youtube:B},U=class{_lastUrl=window.location.href;_onPageInfoChangedListeners=new Set;getPageInfo(){let e=this.getSiteByUrl(),t=D[e].getPageInfo();return this._lastUrl!==t.url&&(this._onPageInfoChangedListeners.forEach((e=>{e(t);})),this._lastUrl=t.url),t}getSiteByUrl(e=window.location.href){switch(new URL(e).hostname.replace(/^www\./,"")){case"twitch.tv":case"player.twitch.tv":return "twitch";case"youtube.com":case"m.youtube.com":return "youtube";default:return "genericSite"}}addOnPageInfoChangedListener(e){this._onPageInfoChangedListeners.add(e);}removeOnPageInfoChangedListener(e){this._onPageInfoChangedListeners.delete(e);}};function F(){return q||(q=new U),q}var _,W=100,$=3e3;function V({onPageInfoChange:e,onDomChange:t,platform:n}){let r=()=>{H(n,e),t(),F().getPageInfo();},o=()=>{let e=document.querySelector("body");if(!e)return void console.error("body not found");let t=function(e,t=200){let n;return (...r)=>{clearTimeout(n),n=setTimeout((()=>e(...r)),t);}}(r,W);new MutationObserver(t).observe(e,{childList:!0,subtree:!0});};["interactive","complete"].includes(document.readyState)?o():window.addEventListener("DOMContentLoaded",o),setInterval(r,$),H(n,e);}function H(e,t){let n=J(e),r=JSON.stringify(n);r!==_&&(_=r,t(n));}function J(e){let t=F().getSiteByUrl();return D[t].getPageIdentifiers(e)}var G="query GetEmbedConnection(\n    $input: EmbedConnectionInput\n  ) {\n  embedConnection(input: $input) {\n    nodes {\n      id\n      name\n      iconUrl\n      slug\n      orgId\n      url\n      packageId\n      packageInstallId\n      isLoginRequired\n      windowProps\n      defaultLayoutConfigSteps { action, value }\n      iframeUrl\n      sourceType\n      sourceId\n    }\n  }\n}";async function Q({sources:e,statuses:t}){let n={input:{sources:e,extensionVersion:"4.3.6",statuses:t}};try{return (await async function(e,t,n,{throwIfErrors:r}={}){let o=await(await fetch(e,{method:"POST",headers:{Authorization:"Bearer pk_U1x92ZrrdQoflf2JycecdmnilAGRAkmUNBpxPnVPDdeUKcsH","Content-Type":"application/json"},body:JSON.stringify({query:t,variables:n})})).json();if(r&&o?.errors)throw new Error(`truffle graphql error ${o.errors}`);return o.data}("https://mycelium.truffle.vip/graphql",G,n)).embedConnection}catch(e){console.error(e);}}var z=new class{promise;resolve;reject;constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t;}));}};var X="truffle-embed",Z="truffle-embed",K=[];async function Y({platform:e,pageIdentifiers:t,isExperimentalEnabled:n}){let r=n?["published","experimental"]:["published"];["native-android","native-ios"].includes(e)&&(r[0]="native");let o=t.map((({sourceType:e,sourceId:t})=>({sourceType:e,sourceId:t})));((await Q({sources:o,statuses:r}))?.nodes||[]).forEach((e=>{!function(e){if(K.find((t=>e.id===t.embed.id)))return;let t=document.createElement("iframe");t.src=e.url||e.iframeUrl,t.id=te(e),t.className=X,t.allow="fullscreen; microphone; camera; autoplay; encrypted-media;",t.setAttribute("style",g),t.dataset.truffleEmbedId=e.id,t.dataset.orgId=e.orgId;let n={embed:e,element:t};K.push(n),ee(n);}(e);}));}function ee(e){let t=function(e){let t,n=localStorage.getItem(re(e.id));try{t=n&&JSON.parse(n);}catch{console.error("error parsing json",n);}return t||e.defaultLayoutConfigSteps}(e.embed);x(t,{subjectElement:e.element});}function te(e){return `${Z}-${e.id}`}function ne(e){if(function(e){return !(!e||e.ownerDocument===document)}(e)){let t=e?.ownerDocument;return !(!t?.defaultView||!t?.body.contains(e))}return !!e?.parentNode}function re(e){return `${w}:embedLayoutConfigSteps:${e}`}function oe(e){return K.find((t=>t.element.contentWindow===e))}window.addEventListener("blur",(()=>{K.find((e=>{document.activeElement==e.element&&async function({metricSlug:e,orgId:t,dimensionValues:n}){let r=await(await z.promise).getGlobalUserAccessToken();fetch("https://mycelium.truffle.vip/graphql",{method:"POST",body:JSON.stringify({query:"mutation DatapointIncrementUnique ($input: DatapointIncrementUniqueInput!) {datapointIncrementUnique(input: $input) { isUpdated }}",variables:{input:{metricSlug:e,dimensionValues:n}}}),headers:{"Content-Type":"application/json","x-org-id":t,"x-access-token":r}});}({metricSlug:"embed-engaged-users",orgId:e.embed.orgId,dimensionValues:{embed:e.embed.slug||e.embed.slug}});}));}));function se(e,t){let{observer:n,listenElement:r,targetQuerySelector:o,emit:s,normalizeElement:a,observerConfig:i,prepareLayoutConfigSteps:l}=e;if(!r)return;let u=r.querySelectorAll(o),c=Array.from(u||[]).map((e=>a(e)));s(c),l&&u.forEach((e=>{x(l,{subjectElement:e,cleanupMutationsByMutatedElementId:t});})),n.observe(r,i);}var ae=new class{constructor(){this.jumper=new f,this.observerObjects=[],this.messageCallbacks=[],this.mutatedElementIdMap=new Map,this.mutationObserverIdMap=new Map;}jumper;observerObjects;messageCallbacks;mutatedElementIdMap;mutationObserverIdMap;call=(e,t)=>this.jumper.call(e,t);listen=()=>{this.jumper.listen(),this.jumper.on("context.getInfo",this.contextGetInfo),this.jumper.on("context.getEmbeds",this.contextGetEmbeds),this.jumper.on("layout.applyLayoutConfigSteps",this.layoutApplyLayoutConfigSteps),this.jumper.on("layout.setDefaultLayoutConfigSteps",this.layoutSetDefaultLayoutConfigSteps),this.jumper.on("layout.addEventListener",this.layoutAddEventListener),this.jumper.on("layout.dispatchEvent",this.layoutDispatchEvent),this.jumper.on("layout.click",this.layoutClick),this.jumper.on("layout.listenForElements",this.layoutListenForElements),this.jumper.on("layout.getElementBoundingClientRect",this.getElementBoundingClientRect),this.jumper.on("comms.postMessage",this.commsPostMessage),this.jumper.on("comms.onMessage",this.commsOnMessage),this.jumper.on("storage.get",this.storageGet),this.jumper.on("storage.set",this.storageSet),this.jumper.on("platform.log",this.platformLog);};platformLog=e=>{console.log(e),window?.ReactNativeWebView?.postMessage(`platform.log: ${JSON.stringify(e)}`);};cleanupEmbedInstance=e=>{this.messageCallbacks=this.messageCallbacks.filter((({eventSource:t})=>!(e.element.contentWindow===t))),this.observerObjects=this.observerObjects.filter((({eventSource:t,mutationObserverId:n})=>{let r=e.element.contentWindow===t;return r&&this.cleanupMutationsByMutationObserverId(n),!r}));};cleanupMutationsByMutatedElementId=e=>{this.mutatedElementIdMap.get(e)?.forEach((e=>e.remove()));};cleanupMutationsByMutationObserverId=e=>{this.mutationObserverIdMap.get(e)?.forEach((e=>e.remove()));};contextGetInfo=async()=>{let e=function(){if("ReactNativeWebView"in window)return navigator.userAgent.match(/iP(hone|od|ad)/g)?"native-ios":"native-android";if(navigator.userAgent.indexOf("Chrome"))return "extension-chrome";if(navigator.userAgent.includes("Firefox"))return "extension-firefox";if(navigator.userAgent.indexOf("Safari"))return "extension-safari"}();return {version:"4.3.6",platform:e,pageInfo:J(e)}};contextGetEmbeds=()=>K.map((e=>({embed:e.embed,element:null})));layoutApplyLayoutConfigSteps=async({layoutConfigSteps:e,mutatedElementId:t},{e:n}={})=>{let r,o;if(n?(o=n?.source&&await this.getEmbedInstanceByEventSource(n.source),r=o?.element):r=document.documentElement,!r)throw new Error("DOM element not found");let s=this.observerObjects.find((({eventSource:e})=>o?.element.contentWindow===e));var a;x(e,{subjectElement:r,mutationObserverId:s?.mutationObserverId,mutatedElementId:t,cleanupMutationsByMutatedElementId:this.cleanupMutationsByMutatedElementId}),s?.shouldCleanupMutatedElements&&(s.mutationObserverId&&this.mutationObserverIdMap.set(s.mutationObserverId,Array.from(document.querySelectorAll((a=s.mutationObserverId,`[${I(a)}]`)))),t&&this.mutatedElementIdMap.set(t,Array.from(document.querySelectorAll((e=>`[${S(e)}]`)(t)))));};layoutSetDefaultLayoutConfigSteps=({layoutConfigSteps:e},{e:t}={})=>{let n;if(t?.source&&(n=oe(t.source)),!n)throw new Error("extension mapping not found");localStorage.setItem(re(n.embed.id),JSON.stringify(e)),x(e,{subjectElement:n.element,cleanupMutationsByMutatedElementId:this.cleanupMutationsByMutatedElementId});};layoutDispatchEvent=({targetElementLayoutConfigSteps:e,eventName:t})=>{let n=x(e);if(!n)throw new Error("DOM element not found");n?.dispatchEvent(new Event(t));};layoutClick=({targetElementLayoutConfigSteps:e})=>{let t=x(e);if(!t)throw new Error("DOM element not found");t?.click();};layoutAddEventListener=({targetElementLayoutConfigSteps:e,eventName:t},n)=>{let r=x(e);if(!r)throw new Error("DOM element not found");r?.addEventListener(t,n);};layoutListenForElements=({listenElementLayoutConfigSteps:e,targetQuerySelector:t,pickStyles:n=[],observerConfig:r={},prepareLayoutConfigSteps:o,shouldCleanupMutatedElements:s=!1},a,{e:i}={})=>{if("function"!=typeof a)return void console.warn("Emit function not set");let l=Date.now().toString(36)+Math.random().toString(36).substr(2),u=e=>{let t=e.getAttribute(M)||"",r=!!e.getAttribute(k),o=t||Date.now().toString(36)+Math.random().toString(36).substr(2);t||e.setAttribute(M,o);let s=n?.length?function(e,t){return Object.fromEntries(t.filter((t=>t in e)).map((t=>[t,e[t]])))}({...window.getComputedStyle(e)},n):{},a=Object.fromEntries(Array.from(e.attributes).map((e=>[e.nodeName,e.nodeValue])));return {id:o,existingMutatedElementId:t,hasMutated:r,mutationObserverId:l,attributes:a,data:e.data,innerText:e.innerText,innerHtml:e.innerHTML,styles:s}},c=this.observerObjects.find((({eventSource:e})=>e===i?.source));c&&(c.observer.disconnect(),l=c.mutationObserverId);let d=new MutationObserver((e=>{let n=e.filter((e=>!("attributes"!==e.type||!e.target?.matches(t))||(e?.addedNodes&&Array.from(e.addedNodes).filter((e=>e?.matches&&e.matches(t))))?.length>0)).map((e=>"attributes"===e.type?e.target:Array.from(e.addedNodes))).flat(),r=n.map(u);r?.length&&(a(r),o&&n.forEach((e=>{x(o,{subjectElement:e,cleanupMutationsByMutatedElementId:this.cleanupMutationsByMutatedElementId});})));})),m=x(e,{cleanupMutationsByMutatedElementId:this.cleanupMutationsByMutatedElementId}),h={eventSource:i?.source,observer:d,listenElement:m,listenElementLayoutConfigSteps:e,observerConfig:r,targetQuerySelector:t,emit:a,normalizeElement:u,prepareLayoutConfigSteps:o,mutationObserverId:l,shouldCleanupMutatedElements:s};if(this.observerObjects.push(h),!m)throw console.warn("missing dom element",e,window.location.href),new Error("DOM element not found");se(h,this.cleanupMutationsByMutatedElementId);};commsPostMessage=(...e)=>{this.messageCallbacks.forEach((({callback:t})=>t(...e)));};commsOnMessage=(e,{e:t}={})=>{this.messageCallbacks.push({callback:e,eventSource:t?.source});};storageGet=({key:e})=>localStorage.getItem(`${w}:${e}`);storageSet=({key:e,value:t})=>{localStorage.setItem(`${w}:${e}`,t);};attachDetachedMutationObservers=()=>{this.observerObjects.forEach((e=>{let t=e.listenElement&&ne(e.listenElement),n=t?e.listenElement:x(e.listenElementLayoutConfigSteps,{cleanupMutationsByMutatedElementId:this.cleanupMutationsByMutatedElementId});n&&!t&&(e.listenElement=n,se(e,this.cleanupMutationsByMutatedElementId));}));};getElementBoundingClientRect({querySelector:e}){return e?document.querySelector(e)?.getBoundingClientRect():void 0}getEmbedInstanceByEventSource=async e=>{let t=e&&oe(e);if(t)return t;let n=await this.call("context.getEmbeds",{}),r=[...Array.from(document.querySelectorAll("iframe"))].find((t=>t.contentWindow===e));return t=n.find((e=>te(e.embed)===r?.id)),r&&t&&(t.element=r),t}};const ie=new e,le=y.CHROME;async function ue(){const e=await ie.fetch("/extension/fcm-token");return null==e?void 0:e.body}!function({onPageInfoChange:e,onDomChange:t,platform:n,privilegedContentScriptApi:r,isExperimentalEnabledPromise:o}){((function(e){T=e;}))(n),function(e){z.resolve(e);}(r),ae.listen(),V({onPageInfoChange:async t=>{!function(e,t){console.log("cleaning up embeds",K);let n=[],r=[];K.forEach((t=>{let{embed:o}=t;e.find((({sourceType:e,sourceId:t})=>o.sourceType===e&&o.sourceId===t))?r.push(t):n.push(t);})),n.forEach((e=>{let{element:n}=e;n&&(t.cleanupEmbedInstance(e),n?.remove());})),K=r;}(t,ae);let r=await o;Y({platform:n,pageIdentifiers:t,isExperimentalEnabled:r}),e?.(t);},onDomChange:()=>{K.forEach((e=>{ne(e.element)||ee(e);})),ae.attachDetachedMutationObservers(),t?.();},platform:n});}({isExperimentalEnabledPromise:async function(e){return Boolean(await(t=e.fetch("/spore/fetch-is-experimental-enabled").then((e=>null==e?void 0:e.body)),n=1e3,r=!1,Promise.race([t,new Promise((e=>setTimeout((()=>e(r)),n)))])));var t,n,r;}(ie),platform:le,privilegedContentScriptApi:a$1}),ae.jumper.on("user.setAccessToken",(async function({accessToken:e}){return await a$1.setGlobalUserAccessToken(e)})),ae.jumper.on("user.getAccessToken",(async function(){return await a$1.getGlobalUserAccessToken()})),ae.jumper.on("extension.getFCMToken",ue),ae.jumper.on("extension.getFcmToken",ue),ae.jumper.on("extension.removeRequestHeaders",(async function({headers:e=[],ttlMs:t=5e3}){t=Math.min(t,6e5);return (await ie.fetch("/extension/remove-request-headers-temporarily",{headers:e,ttlMs:t})).body})),ae.jumper.on("extension.setCookieSameSiteNone",(async function({url:e,name:t}){return (await ie.fetch("/extension/set-cookie-same-site-none",{url:e,name:t})).body})),ae.jumper.on("user.invalidateSporeUser",(async function({orgId:e}){const n=J(le);if(function(e){return e.find((e=>e.sourceType.includes("youtube")))}(n)){const n=await ie.fetch("/auth/token"),r=r$1(null==n?void 0:n.body);if(!r)return;ie.fetch("/spore/invalidate-spore-user-cache",{connectionSourceId:r.sub,sporeOrgId:e}),r.spore||ie.fetch("/gateway/set-settings",{hasSporeCollectible:!0});}})),ae.jumper.on("twitch.getSubscribeButtonUser",(async function({channelName:e}){if(!window.location.host.includes("twitch.tv"))throw new Error("must be called from twitch.tv");const t=(await ie.fetch("/twitch/get-gql-headers")).body;try{return (await fetch("https://gql.twitch.tv/gql",{headers:t,referrer:"https://player.twitch.tv/",referrerPolicy:"strict-origin-when-cross-origin",body:`[{"operationName":"ChannelPage_SubscribeButton_User","variables":{"login":"${e}"},"extensions":{"persistedQuery":{"version":1,"sha256Hash":"711531c82eba59a653a495c90814d10c0e06c722dd915f7a60565e459960c4bb"}}}]`,method:"POST"})).json()}catch(e){throw console.log("fetch err",e),e}}));
